---
import Layout from "../layouts/Layout.astro";
import { loadQuery } from "../sanity/lib/load-query";
import { urlForImage } from "../sanity/lib/url-for-image";
import Watchall from "../components/Watchall.astro";
import ProjectCard from "../components/ProjectCard.astro";

// Query to get projects from CMS
const POSTS_QUERY = `*[_type == "post"] | order(publishedAt desc)[0...3]{
  title,
  "slug": slug.current,
  mainImage,
  publishedAt,
  body
}`;

const { data: posts } = await loadQuery<Array<{
  title: string;
  slug: string;
  mainImage: { asset: any; alt?: string };
  publishedAt: string;
  body: any;
}>>({
  query: POSTS_QUERY,
});

// Query to get the first 5 images from all galleries
const GALLERY_IMAGES_QUERY = `*[_type == "post" || _type == "page"]{
  "allImages": content[_type == "gallery"][].images[]{
    asset,
    alt
  }
}[defined(allImages) && count(allImages) > 0][0].allImages[0...5]`;

const { data: images } = await loadQuery<Array<{asset: any, alt?: string}>>({
  query: GALLERY_IMAGES_QUERY,
});
---

<Layout title="| Home">
  <section class="panel panel-1">
    <div class="hero-text">
      <h1>Matthijs</h1>
      <h2>Portfolio</h2>
      <h2>Frontend Developer</h2>
    </div>
  </section>

  <section class="panel panel-2">
    <div class="section-title">
      <h3>Work</h3>
      <Watchall href="/work" />
    </div>
    {posts && posts.map((post, index) => (
      <ProjectCard 
        title={post.title}
        image={post.mainImage ? urlForImage(post.mainImage.asset).width(1200).url() : '/src/assets/dda-background.png'}
        imageAlt={post.mainImage?.alt || post.title}
        category="Development / Projecten"
        date={new Date(post.publishedAt).toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' })}
        datetime={post.publishedAt}
        isOpen={index === 0}
      />
    ))}

    <div class="section-title">
      <h3>About me</h3>
      <Watchall href="/about-me" />
    </div>

    <h4>Reizen</h4>
    <p class="travel-description">Ik heb echt al heel veel mooie plekken op de aarde mogen zien, maar ik ben nog lang niet klaar. Van Amerika naar AziÃ« naar Zuid-Afrika. Ik wil het liefst de hele wereld zien.</p>

    <div class="travel-images">
      {images && images.map((img) => (
        <img 
          src={urlForImage(img.asset).width(800).url()} 
          alt={img.alt || 'Travel photo'} 
          width={800}
          height={250}
          loading="lazy"
        />
      ))}
    </div>
  </section>
</Layout>

<style>
  

  .hero-text {
    position: absolute;
    bottom: 15vh;
    display: grid;
    grid-template-rows: repeat(3, min-content);
    grid-column: 2 / 10;
    line-height: 1.1;
    gap: 0;
    @media (min-width: 600px) {
      grid-column: 2 / 10;
    }
  }

  .hero-text h1 {
    font-size: clamp(4rem, 10vw, 8rem);
    grid-row: 2;
    margin: 0;
    padding: 0;
    margin-left: -3px;
  }

  h2 {
    font-size: clamp(1.75rem, 5vw, 2.5rem);
  }

  .panel {
    position: sticky;
    top: 0;
    height: 100vh;
    display: grid;
    grid-template-columns: var(--grid-columns);
  }

  .panel-2 {
    height: min-content;
    background: var(--secondary-color);
    display: grid;
    padding-top: 2rem;
  }

  .section-title {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    margin: 1rem 0 2rem 0;
    line-height: 1;
    grid-column: 2/12;
      @media (min-width: 400px) {
        flex-direction: row;
      }
      &:nth-of-type(2) {
        padding-top: 2rem;
      }
  }

  .panel-2 h3 {
    font-size: clamp(4rem, 10vw, 6rem);
  }

  .panel-2 h4 {
    font-size: clamp(2rem, 5vw, 3rem);
    grid-column: 2/12;
  }
  .travel-description {
    font-size: 1.25rem;
    grid-column: 2/12;
    max-width: 800px;
    margin-top: 0.5rem;
  }

  .travel-images {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
    grid-column: 2/12;
    padding-bottom: 2rem;
  }

  .travel-images img {
    width: 100%;
    height: 250px;
    object-fit: cover;
    border-radius: 4px;
  }

</style>
